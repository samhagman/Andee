name = "claude-sandbox-worker"
main = "src/index.ts"
compatibility_date = "2024-12-01"

# Keep workers.dev route active for main API access
workers_dev = true

# Custom domain for exposed sandbox ports (terminal, web apps, etc.)
# Uses single-level subdomains for Universal SSL compatibility:
#   https://8081-chat-999999999.samhagman.com (covered by *.samhagman.com)
# DNS setup required in Cloudflare Dashboard:
#   Add A record: * -> 192.0.2.0 (proxied)
routes = [
  { pattern = "*.samhagman.com/*", zone_name = "samhagman.com" }
]

# ┌─────────────────────────────────────────────────────────────────────────┐
# │ IMPORTANT: This port must match SANDBOX_WORKER_URL in                  │
# │ ../claude-telegram-bot/.env                                            │
# └─────────────────────────────────────────────────────────────────────────┘
[dev]
port = 8787

# Environment variables
# Set DEBUG=true to enable verbose debug logging (visible in wrangler tail)
[vars]
DEBUG = "false"
# Engine selection: which AI backend to use for processing messages
# Options: claude (Anthropic SDK), goose (Goose CLI), opencode (OpenCode SDK)
# Both Goose and OpenCode use Cerebras GLM-4.7 (cheap + fast)
USE_ENGINE = "opencode"

# Secrets (set via: npx wrangler secret put <SECRET_NAME>)
# ANTHROPIC_API_KEY     - Required for Claude SDK path (USE_GOOSE=false)
# CEREBRAS_API_KEY      - Required for Goose path (USE_GOOSE=true)
# PERPLEXITY_API_KEY    - Required for web search MCP (USE_GOOSE=true)
# ANDEE_API_KEY         - API key for authenticating requests
# AWS_ACCESS_KEY_ID     - For R2 bucket mounting
# AWS_SECRET_ACCESS_KEY - For R2 bucket mounting
# CLOUDFLARE_ACCOUNT_ID - For R2 bucket mounting

# Durable Object bindings
[durable_objects]
bindings = [
  { name = "Sandbox", class_name = "Sandbox" },
  { name = "Scheduler", class_name = "SchedulerDO" },
  { name = "RecurringSchedules", class_name = "RecurringSchedulesDO" }
]

# Migrations - Sandbox and SchedulerDO require SQLite storage
[[migrations]]
tag = "v1"
new_sqlite_classes = ["Sandbox"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["SchedulerDO"]

[[migrations]]
tag = "v3"
new_sqlite_classes = ["RecurringSchedulesDO"]

# Container configuration (wrangler 4.x format)
# Instance types: lite (1/16 vCPU), basic (1/4), standard-1 (1/2),
#                 standard-2 (1 vCPU), standard-3 (2), standard-4 (4)
[[containers]]
class_name = "Sandbox"
image = "./Dockerfile"
instance_type = "standard-4"  # 4 vCPU, 12 GiB RAM, 20 GB disk (max available)

# R2 binding for transcript persistence (optional enhancement)
[[r2_buckets]]
binding = "TRANSCRIPTS"
bucket_name = "andee-transcripts"

# R2 binding for session storage (shared with telegram bot)
[[r2_buckets]]
binding = "SESSIONS"
bucket_name = "andee-sessions"

# R2 binding for filesystem snapshots (backup/restore workspace)
[[r2_buckets]]
binding = "SNAPSHOTS"
bucket_name = "andee-snapshots"

# R2 binding for persistent media storage (photos, voice, documents)
# Mounted at /media in containers via sandbox.mountBucket()
[[r2_buckets]]
binding = "MEDIA"
bucket_name = "andee-media"

# Import .script.js files as raw text (for container scripts)
# These scripts run inside Docker containers, not in the Worker runtime
[[rules]]
type = "Text"
globs = ["**/*.script.js"]
fallthrough = true

# Cron trigger for hourly proactive checks
# Runs at minute 0 of every hour to evaluate if Andee should send proactive messages
[triggers]
crons = ["0 * * * *"]

# Workers AI binding for speech-to-text (voice message transcription)
[ai]
binding = "AI"
